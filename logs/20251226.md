# TNM Wizard Refactor and Quality Report (FastAPI + TypeScript + Templates)

## 1. Scope and Goals

We worked through a refactor and QA pass of a TNM Wizard codebase that includes:

* **FastAPI** backend (`app.py`) for serving organ-specific forms and generating a report output.
* **Jinja2 templates** (e.g., `templates/form_generic.html`) for rendering a generic dynamic form UI.
* **Static client scripts** migrated from JavaScript to **TypeScript** (e.g., `static-src/visibility.ts`, `static-src/copy.ts`), compiled into `static/`.
* **SonarLint / SonarQube** rule compliance improvements, especially around:

  * Cognitive Complexity (`S3776`)
  * Unnecessary type assertions (`typescript:S4325`)
  * Deprecated APIs (`typescript:S1874`)
  * HTML accessibility labels (`Web:S6853`)
  * Redundant calls (`python:S7508`)
  * Naming conventions (regex: `^[_a-z][a-z0-9_]*$`)

Main functional features addressed:

* Generic `visible_if` conditional UI rendering.
* Legacy histologic type -> subtype filtering.
* Legacy “checkbox + % input” toggling.
* New histologic “mix table” behavior:

  * Type->subtype filtering per row
  * AD-only percentage entry + sum check/hints
  * Non-AD: enforce only one row visible
* Mix table -> “description” textarea autofill helper.
* Clipboard copy helper for the generated report text.

---

## 2. Static File Routing and Runtime Implications

### 2.1 Observed log output

```
INFO:     127.0.0.1:51460 - "GET /lung HTTP/1.1" 200 OK
INFO:     127.0.0.1:51460 - "GET /static/dom HTTP/1.1" 404 Not Found
```

### 2.2 What this implied

* `/lung` rendered successfully (form route working).
* `/static/dom` returned 404, implying either:

  * a request for `/static/dom` was made but the file does not exist under the mounted `static/` directory, or
  * a template/script tag referenced a wrong path (e.g., missing file extension, wrong filename, stale build output).

### 2.3 Static mount used

```python
app.mount("/static", StaticFiles(directory=str(BASE_DIR / "static")), name="static")
```

This requires compiled JS to exist in `BASE_DIR/static/` at the referenced path.

---

## 3. TypeScript Migration: `visibility.js` -> `visibility.ts`

### 3.1 Original JavaScript responsibilities (summary)

* Conditional field visibility based on:

  * `data-visible-if-field`
  * `data-visible-if-values`
* Legacy histologic subtype filtering (`select[name="histologic_type"]`).
* Legacy subtype percent toggling (`.histologic-subtype-row`).
* New histologic mix table:

  * subtype options filtered per selected type per row
  * AD-only percent input behavior; hide percent `<td>` when non-AD
  * enforce only one non-AD row visible
  * AD total check and hint display
* Build summary and inject into `textarea#description` via button `btn-fill-description-from-histology`.

### 3.2 TypeScript refactor patterns introduced

* “Sonar-friendly” DOM helpers:

  * untyped query functions to avoid unnecessary assertions
  * typed wrappers for explicit type shaping
* Avoid storing custom fields on DOM nodes (replaced with `WeakMap` cache)

Example:

```ts
const subtypeOptionsCache = new WeakMap<HTMLElement, HTMLOptionElement[]>();
```

### 3.3 Safer refactor for `closest("td")` without casts

We targeted this pattern:

```ts
const pctCell = r.pctInput.closest("td");
```

To avoid `as HTMLElement` style casting and make checks safe, we used runtime guards:

```ts
function updateRowMode(r: MixRowEls): void {
  const typeCode = r.typeSelect.value;
  const pctCell = r.pctInput.closest("td");

  const setCellDisplay = (display: "" | "none") => {
    if (pctCell instanceof HTMLElement) pctCell.style.display = display;
  };

  if (typeCode === AD_CODE) {
    r.pctInput.disabled = false;
    r.pctInput.required = true;
    r.pctInput.style.visibility = "visible";
    setCellDisplay("");
  } else if (typeCode === "") {
    r.pctInput.disabled = false;
    r.pctInput.required = false;
    r.pctInput.style.visibility = "visible";
    setCellDisplay("");
  } else {
    r.pctInput.value = "";
    r.pctInput.disabled = true;
    r.pctInput.required = false;
    r.pctInput.style.visibility = "hidden";
    setCellDisplay("none");
  }
}
```

---

## 4. TypeScript Lint/Build Issues and Fixes

### 4.1 Unnecessary assertion (`typescript:S4325`)

Observed:

```
typescript:S4325 "This assertion is unnecessary since it does not change the type of the expression."
```

Cause:

* Type assertions like `as T` were used where TypeScript already inferred the type, or where the cast did not change the expression type.

Mitigation adopted:

* Keep casts only inside typed wrappers (`qsT`, `qsaT`, `byIdT`) and use untyped wrappers for generic DOM selection to reduce Sonar noise.

### 4.2 Duplicate function implementation (TS2393)

Observed:

```
% npx tsc
static-src/copy.ts:3:10 - error TS2393: Duplicate function implementation.
static-src/visibility.ts:21:10 - error TS2393: Duplicate function implementation.
```

Implication:

* TypeScript treated both files as scripts in the same global scope, so top-level `function byId...` collided.

Fix options:

* Convert files to modules by adding at least one real `export` or `import`.
* Or consolidate shared functions into a shared module imported by both.

### 4.3 Sonar rule: export without specifiers (`typescript:S7787`)

Observed:

```
typescript:S7787 "export statement without specifiers is not allowed."
```

This typically occurs when adding `export {};` solely to force module scope.

Recommended fix (module-safe without `export {};`):

* Create a shared module (e.g., `static-src/dom.ts`) exporting `qsT/qsaT/byIdT`, then import it in each file.
* Or export a real symbol from each file (e.g., `export function initVisibility() { ... }`).

### 4.4 Deprecated API warning (`typescript:S1874`) in copy helper

Observed:

```
typescript:S1874: 'document.execCommand' is deprecated.
```

The copy logic used:

* `navigator.clipboard.writeText` first
* `document.execCommand("copy")` as fallback

Since a fallback is still pragmatic, acceptable outcomes were:

* Keep the fallback but optionally suppress Sonar warning with a targeted suppression comment (depending on lint policy).
* Prefer the Clipboard API whenever available.

### 4.5 TypeScript build configuration

`tsconfig.json` used:

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "lib": ["DOM", "ES2020"],
    "module": "ES2020",
    "moduleResolution": "Bundler",
    "strict": true,
    "noImplicitAny": true,
    "skipLibCheck": true,
    "outDir": "static",
    "rootDir": "static-src"
  },
  "include": ["static-src/**/*.ts"]
}
```

Implications:

* Output goes to `static/` which aligns with `FastAPI` static mount.
* Using ESM requires templates to load compiled JS with `<script type="module" ...>` (already used).

---

## 5. Clipboard Copy Script Migration: JS -> TS

### 5.1 Source logic (JS)

```js
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("copyBtn");
  const textarea = document.getElementById("reportText");

  if (!btn || !textarea) return;

  btn.addEventListener("click", async () => {
    const text = textarea.value;

    if (navigator.clipboard) {
      try {
        await navigator.clipboard.writeText(text);
        alert("診断文をクリップボードにコピーしました。");
        return;
      } catch (e) {
        console.error("navigator.clipboard failed", e);
      }
    }

    textarea.focus();
    textarea.select();
    try {
      const success = document.execCommand("copy");
      ...
    } catch (e) {
      ...
    }
  });
});
```

### 5.2 Migration considerations

* Ensure `textarea` is typed as `HTMLTextAreaElement`, not generic `HTMLElement`.
* Keep Clipboard API as the primary path.
* Keep fallback with awareness of deprecation warnings.

---

## 6. HTML Template Accessibility: `Web:S6853`

Observed:

```
Web:S6853 "A form label must be associated with a control."
```

In `templates/form_generic.html`, label patterns included:

* Plain label without `for` + missing input `id` (problem)
* Label wrapping input (valid)
* Label with `for="{{ field.name }}"` where input may not have matching `id` (problem)

Key problematic structure example:

```html
<label>{{ field.label }}:</label>
<table>...</table>
```

Fix strategy:

* If label is meant to label a control, ensure:

  * control has an `id`, and label has `for="that-id"`, or
  * label wraps the control element

For the histologic mix table, use:

* a `<caption>` for the table title, or
* `aria-labelledby` referencing a heading element, or
* convert the label into a heading and keep table semantics clean.

---

## 7. Backend (`app.py`) Sonar Issues and Refactors

### 7.1 Cognitive complexity (`python:S3776`)

Observed earlier:

* complexity complaints in route handlers and histology summary builder
* explicit message example:

  * “reduce Cognitive Complexity from 48 to the 15 allowed”

Fix approach used:

* Split large functions into focused helpers:

  * `_build_histology_label_maps`
  * `_collect_histology_rows`
  * `_pick_primary_row`
  * `_format_primary_parts`
  * `_format_non_primary_part`

### 7.2 Naming convention warnings (regex)

Observed:

* Rename parameter/local variables like `pT`, `pN`, `pM` to match:

  * `^[_a-z][a-z0-9_]*$`

Fix:

* Use snake_case variables:

  * `pt`, `pn`, `pm`
* Keep form field names as-is if required by UI, but map them internally.

### 7.3 Multi-value form concerns: `dict(form)` loses repeated keys

Issue:

* `dict(form)` keeps only one value per key for repeated keys (checkbox groups).

Resolution:

* Prefer passing `form` directly (Starlette `FormData`) into readers that can call `.getlist()`.
* Keep `getlist()` helper that accepts `SupportsGetList`.

### 7.4 `python:S7508` redundant call

Observed:

```
python:S7508 "Remove this redundant call."
```

Typical cause in this context:

* `set(list(form_data))` or similar

Fix:

* Replace redundant wrapper calls:

  * `sorted(set(form_data))` instead of `sorted(set(list(form_data)))`
  * or `sorted(set(form_data.keys()))` where appropriate

---

## 8. Current Import Block Review

We reviewed the import header and recommended:

* Grouping standard library and third-party imports.
* Removing unused imports (`Tuple` if using `tuple[...]`, unused `Dict`/`List` if moving to built-in generics, etc.).
* Keeping `from __future__ import annotations` to reduce forward-reference and typing friction.

Example style:

```python
from __future__ import annotations

import json
import re
from dataclasses import dataclass
from pathlib import Path
from typing import Any, Dict, Iterable, List, Mapping, Optional, Protocol, runtime_checkable

import yaml
from fastapi import FastAPI, Request
from fastapi.responses import HTMLResponse
from fastapi.staticfiles import StaticFiles
from fastapi.templating import Jinja2Templates
```

---

## 9. How to Run the System (Development Workflow)

### 9.1 Compile TypeScript

From repository root (where `tsconfig.json` exists):

```bash
npx tsc
```

This compiles `static-src/*.ts` to `static/*.js` (ES2020 modules).

### 9.2 Run FastAPI with Uvicorn

Typical command:

```bash
uvicorn app:app --reload
```

Then open:

* `http://127.0.0.1:8000/`
* `http://127.0.0.1:8000/lung` (example organ route)

### 9.3 Ensure templates reference correct compiled assets

Example:

```html
<script type="module" src="/static/visibility.js"></script>
```

If the code is compiled from `static-src/visibility.ts`, the output must be at:

* `static/visibility.js`

A 404 like `/static/dom` indicates a missing file or an incorrect `src` path.

---

## 10. Summary of Key Decisions and Outcomes

* Migrated complex DOM manipulation from JavaScript to TypeScript with:

  * typed wrappers for DOM querying
  * `WeakMap` caching instead of custom properties on nodes
  * safer element checks for `closest("td")`
* Addressed SonarLint feedback systematically:

  * complexity reduction via helper functions
  * removal of redundant calls
  * avoidance of unnecessary TS assertions
  * improved form-data multi-value handling
  * HTML label/control association fixes for accessibility
* Identified module-scope issues causing:

  * TS2393 duplicate function implementation
  * `export {};` related Sonar complaints
  * recommended shared module approach or exporting real symbols

---

## 11. References Mentioned in the Work

* SonarLint / SonarQube issue codes:

  * `python:S3776` (Cognitive Complexity)
  * `python:S7508` (Redundant call)
  * `typescript:S4325` (Unnecessary assertion)
  * `typescript:S1874` (Deprecated `execCommand`)
  * `typescript:S7787` (Export statement without specifiers)
  * `Web:S6853` (Label-control association)
* Runtime stack:

  * FastAPI
  * Uvicorn
  * Jinja2Templates
  * Starlette `FormData` (via `request.form()`)
