# TNM Wizard Refactor and Quality Report (FastAPI + TypeScript + Templates)

## 1. Scope and Goals

We worked through a refactor and QA pass of a TNM Wizard codebase that includes:

* **FastAPI** backend (`app.py`) for serving organ-specific forms and generating a report output.
* **Jinja2 templates** (e.g., `templates/form_generic.html`) for rendering a generic dynamic form UI.
* **Static client scripts** migrated from JavaScript to **TypeScript** (e.g., `static-src/visibility.ts`, `static-src/copy.ts`), compiled into `static/`.
* **SonarLint / SonarQube** rule compliance improvements, especially around:

  * Cognitive Complexity (`S3776`)
  * Unnecessary type assertions (`typescript:S4325`)
  * Deprecated APIs (`typescript:S1874`)
  * HTML accessibility labels (`Web:S6853`)
  * Redundant calls (`python:S7508`)
  * Naming conventions (regex: `^[_a-z][a-z0-9_]*$`)

Main functional features addressed:

* Generic `visible_if` conditional UI rendering.
* Legacy histologic type -> subtype filtering.
* Legacy “checkbox + % input” toggling.
* New histologic “mix table” behavior:

  * Type->subtype filtering per row
  * AD-only percentage entry + sum check/hints
  * Non-AD: enforce only one row visible
* Mix table -> “description” textarea autofill helper.
* Clipboard copy helper for the generated report text.
* Conditional output requirement for specific fields (e.g., “切除マージンまでの距離(mm)”) and how it differs between UI and report rendering.

---

## 2. Static File Routing and Runtime Implications

### 2.1 Observed log output

```
INFO:     127.0.0.1:51460 - "GET /lung HTTP/1.1" 200 OK
INFO:     127.0.0.1:51460 - "GET /static/dom HTTP/1.1" 404 Not Found
```

Other dev runs showed successful asset serving for compiled modules:

```
INFO:     Uvicorn running on http://127.0.0.1:8000
INFO:     127.0.0.1:53390 - "GET /lung HTTP/1.1" 200 OK
INFO:     127.0.0.1:53390 - "GET /static/visibility.js HTTP/1.1" 304 Not Modified
WARNING:  StatReload detected changes in 'app.py'. Reloading...
INFO:tnm:LOADED app.py: /Users/tkshfj/Dropbox/repository/tnm-wizard/app.py
```

### 2.2 What this implied

* `/lung` rendered successfully (form route working).
* `/static/dom` returned 404, implying either:

  * a request for `/static/dom` was made but the file does not exist under the mounted `static/` directory, or
  * a template/script tag referenced a wrong path (e.g., missing file extension, wrong filename, stale build output).

### 2.3 Static mount used

```python
app.mount("/static", StaticFiles(directory=str(BASE_DIR / "static")), name="static")
```

This requires compiled JS to exist in `BASE_DIR/static/` at the referenced path (e.g., `static/visibility.js` for `<script type="module" src="/static/visibility.js"></script>`).

---

## 3. Conditional Visibility Requirement: “rm (切除マージンまでの距離(mm))” and Output Control

### 3.1 Requirement

“切除マージンまでの距離(mm)” must be shown in results only when:

* 手術法 (`data.modality`) is **"区域切除術"** or **"部分切除術"**.

### 3.2 YAML field snippet

```yaml
- name: rm
  label: "切除マージンまでの距離(mm)"
  type: number
  input_width: 3.0rem;
  visible_if:
    field: modality
    values:
      - "区域切除術"
      - "部分切除術"
```

### 3.3 Template snippet (result text) and key point

The report template included unconditional output:

```jinja2
切除マージンまでの距離(mm): {{ "%.0f"|format(data.margin_distance or 0) }}
```

Key technical point:

* The `visible_if` mechanism in the TypeScript UI controls **form display**, but it does not automatically control **rendered output**.
* Output control must be done at template rendering time (Jinja2 conditionals) or by removing/clearing the value server-side before rendering.

---

## 4. Server Error: Form Parsing Fails Without `python-multipart`

### 4.1 Error log

```
INFO:     127.0.0.1:52502 - "POST /lung/generate HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
...
File "/Users/tkshfj/Dropbox/repository/tnm-wizard/app.py", line 444, in generate_report
    form = await request.form()
...
AssertionError: The `python-multipart` library must be installed to use form parsing.
```

### 4.2 Root cause

`await request.form()` requires `python-multipart` when the client submits `application/x-www-form-urlencoded` or `multipart/form-data`.

### 4.3 Fix direction

Install the dependency:

* `pip install python-multipart`

---

## 5. TypeScript Migration: `visibility.js` -> `visibility.ts`

### 5.1 Responsibilities

`static-src/visibility.ts` covers:

* Conditional field visibility based on:

  * `data-visible-if-field`
  * `data-visible-if-values`
* Legacy histologic subtype filtering (`select[name="histologic_type"]`).
* Legacy subtype percent toggling (`.histologic-subtype-row`).
* New histologic mix table:

  * subtype options filtered per selected type per row
  * AD-only percent input behavior; hide percent `<td>` when non-AD
  * enforce only one non-AD row visible
  * AD total check and hint display
* Build summary and inject into `textarea#description` via button `btn-fill-description-from-histology`.

### 5.2 TypeScript refactor patterns introduced

* Typed wrappers for DOM querying (to centralize checks/casts) and reduce call-site assertions.
* Avoid storing custom fields on DOM nodes (replaced with `WeakMap` cache):

```ts
const subtypeOptionsCache = new WeakMap<HTMLElement, HTMLOptionElement[]>();
```

### 5.3 Safer refactor for `closest("td")` without casts

We targeted this pattern:

```ts
const pctCell = r.pctInput.closest("td");
```

To avoid `as HTMLElement` style casting and make checks safe, runtime guards were used:

```ts
function updateRowMode(r: MixRowEls): void {
  const typeCode = r.typeSelect.value;
  const pctCell = r.pctInput.closest("td");

  const setCellDisplay = (display: "" | "none") => {
    if (pctCell instanceof HTMLElement) pctCell.style.display = display;
  };

  if (typeCode === AD_CODE) {
    r.pctInput.disabled = false;
    r.pctInput.required = true;
    r.pctInput.style.visibility = "visible";
    setCellDisplay("");
  } else if (typeCode === "") {
    r.pctInput.disabled = false;
    r.pctInput.required = false;
    r.pctInput.style.visibility = "visible";
    setCellDisplay("");
  } else {
    r.pctInput.value = "";
    r.pctInput.disabled = true;
    r.pctInput.required = false;
    r.pctInput.style.visibility = "hidden";
    setCellDisplay("none");
  }
}
```

---

## 6. TypeScript Lint/Build Issues and Fixes

### 6.1 Unnecessary assertion (`typescript:S4325`)

Observed:

```
typescript:S4325 "This assertion is unnecessary since it does not change the type of the expression."
```

Cause:

* Type assertions like `as T` were used where TypeScript already inferred the type, or where the cast did not change the expression type.

Mitigation adopted:

* Keep casts only inside typed wrappers (`qsT`, `qsaT`, `byIdT`) and keep call sites clean to reduce Sonar noise.

### 6.2 Duplicate function implementation (TS2393)

Observed:

```
% npx tsc
static-src/copy.ts:3:10 - error TS2393: Duplicate function implementation.
static-src/visibility.ts:21:10 - error TS2393: Duplicate function implementation.
```

Implication:

* TypeScript treated both files as scripts in the same global scope, so top-level helper definitions collided.

Fix options:

* Convert files to modules by adding at least one real `export` or `import`.
* Or consolidate shared functions into a shared module imported by both.

### 6.3 Sonar rule: export without specifiers (`typescript:S7787`)

Observed:

```
typescript:S7787 "export statement without specifiers is not allowed."
```

This typically occurs when adding `export {};` solely to force module scope.

Recommended fix (module-safe without `export {};`):

* Create a shared module (e.g., `static-src/dom.ts`) exporting `qsT/qsaT/byIdT`, then import it in each file.
* Or export a real symbol from each file (e.g., `export function initVisibility() { ... }`).

### 6.4 Deprecated API warning (`typescript:S1874`) in copy helper

Observed:

```
typescript:S1874: 'document.execCommand' is deprecated.
```

The copy logic used:

* `navigator.clipboard.writeText` first
* `document.execCommand("copy")` as fallback

Since a fallback is still pragmatic, acceptable outcomes were:

* Keep the fallback but optionally suppress Sonar warning with a targeted suppression comment (depending on lint policy).
* Prefer the Clipboard API whenever available.

### 6.5 SonarLint: “Do not call Array#push() multiple times.” (`typescript:S7778`)

Reported at:

```json
[{
  "resource": "/Users/tkshfj/Dropbox/repository/tnm-wizard/static-src/visibility.ts",
  "owner": "sonarlint",
  "code": "typescript:S7778",
  "severity": 4,
  "message": "Do not call `Array#push()` multiple times.",
  "source": "sonarqube",
  "startLineNumber": 426,
  "startColumn": 9,
  "endLineNumber": 426,
  "endColumn": 13,
  "origin": "extHost1"
}]
```

Mitigation patterns used:

* Replace repeated `push()` sequences with:

  * `map(...)` / `filter(...)`
  * single spread/concat construction:

    ```ts
    return [...head, ...(primaryPart ? [primaryPart] : []), ...rest];
    ```

### 6.6 Nested ternary extraction

A nested ternary was flagged and refactored into independent statements.

Original:

```ts
const primaryPart =
  primary.subtypeLabel?.trim()
    ? `${primary.subtypeLabel.trim()} ${pctParen(primary.pct)}`
    : primary.pct > 0
      ? pctParen(primary.pct)
      : "";
```

Refactor:

```ts
const subtypeLabel = primary.subtypeLabel?.trim() ?? "";

let primaryPart = "";
if (subtypeLabel) {
  primaryPart = `${subtypeLabel} ${pctParen(primary.pct)}`;
} else if (primary.pct > 0) {
  primaryPart = pctParen(primary.pct);
}
```

### 6.7 TypeScript build configuration

`tsconfig.json` used:

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "lib": ["DOM", "ES2020"],
    "module": "ES2020",
    "moduleResolution": "Bundler",
    "strict": true,
    "noImplicitAny": true,
    "skipLibCheck": true,
    "outDir": "static",
    "rootDir": "static-src"
  },
  "include": ["static-src/**/*.ts"]
}
```

Implications:

* Output goes to `static/` which aligns with `FastAPI` static mount.
* Using ESM requires templates to load compiled JS with `<script type="module" ...>`.

---

## 7. Clipboard Copy Script Migration: JS -> TS

### 7.1 Source logic (JS)

```js
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("copyBtn");
  const textarea = document.getElementById("reportText");

  if (!btn || !textarea) return;

  btn.addEventListener("click", async () => {
    const text = textarea.value;

    if (navigator.clipboard) {
      try {
        await navigator.clipboard.writeText(text);
        alert("診断文をクリップボードにコピーしました。");
        return;
      } catch (e) {
        console.error("navigator.clipboard failed", e);
      }
    }

    textarea.focus();
    textarea.select();
    try {
      const success = document.execCommand("copy");
      ...
    } catch (e) {
      ...
    }
  });
});
```

### 7.2 Migration considerations

* Ensure `textarea` is typed as `HTMLTextAreaElement`, not generic `HTMLElement`.
* Keep Clipboard API as the primary path.
* Keep fallback with awareness of `typescript:S1874`.

---

## 8. HTML Template Accessibility: `Web:S6853`

Observed:

```
Web:S6853 "A form label must be associated with a control."
```

In `templates/form_generic.html`, label patterns included:

* Plain label without `for` + missing input `id` (problem)
* Label wrapping input (valid)
* Label with `for="{{ field.name }}"` where input may not have matching `id` (problem)

Key problematic structure example:

```html
<label>{{ field.label }}:</label>
<table>...</table>
```

Fix strategy:

* If label is meant to label a control, ensure:

  * control has an `id`, and label has `for="that-id"`, or
  * label wraps the control element

For the histologic mix table, use:

* a `<caption>` for the table title, or
* `aria-labelledby` referencing a heading element, or
* convert the label into a heading and keep table semantics clean.

---

## 9. Backend (`app.py`) Sonar Issues and Refactors

### 9.1 Cognitive complexity (`python:S3776`)

Observed earlier:

* complexity complaints in route handlers and histology summary builder
* explicit message example:

  * “reduce Cognitive Complexity from 48 to the 15 allowed”

Fix approach used:

* Split large functions into focused helpers:

  * `_build_histology_label_maps`
  * `_collect_histology_rows`
  * `_pick_primary_row`
  * `_format_primary_parts`
  * `_format_non_primary_part`

### 9.2 Naming convention warnings (regex)

Observed:

* Rename parameter/local variables like `pT`, `pN`, `pM` to match:

  * `^[_a-z][a-z0-9_]*$`

Fix:

* Use snake_case variables:

  * `pt`, `pn`, `pm`
* Keep form field names as-is if required by UI, but map them internally.

### 9.3 Multi-value form concerns: `dict(form)` loses repeated keys

Issue:

* `dict(form)` keeps only one value per key for repeated keys (checkbox groups).

Resolution:

* Prefer passing `form` directly (Starlette `FormData`) into readers that can call `.getlist()`.
* Keep `getlist()` helper that accepts `SupportsGetList`.

### 9.4 `python:S7508` redundant call

Observed:

```
python:S7508 "Remove this redundant call."
```

Typical cause in this context:

* `set(list(form_data))` or similar

Fix:

* Replace redundant wrapper calls:

  * `sorted(set(form_data))` instead of `sorted(set(list(form_data)))`
  * or `sorted(set(form_data.keys()))` where appropriate

---

## 10. Server-Side Implementation (FastAPI) and Report Generation

### 10.1 Core flow

* Loads YAML organ configs into `FORM_CONFIGS`.
* Renders generic form template (`form_generic.html`).
* POST endpoint extracts form values, builds histology summary, nodal summary, stage, then renders organ-specific report template.

Key endpoint logic:

```py
@app.post("/{organ}/generate", response_class=HTMLResponse)
async def generate_report(request: Request, organ: str):
    cfg = FORM_CONFIGS.get(organ)
    if cfg is None:
        return HTMLResponse("Unknown organ", status_code=404)

    form = await request.form()

    data = extract_fields(form, cfg)
    if cfg.version:
        data["version"] = cfg.version

    data["histologic_summary"] = build_histologic_summary(form, cfg)

    if has_field_type(cfg, "nodal_stations"):
        data["nodal_summary"] = build_nodal_summary(form)
    else:
        data["nodal_summary"] = ""

    pt = data.get("pT")
    pn = data.get("pN")
    pm = data.get("pM")
    if pt and pn and pm:
        data["stage"] = derive_stage(cfg, pt, pn, pm)

    report_template = templates.get_template(cfg.template)
    report_text = report_template.render(data=data)

    return templates.TemplateResponse(
        "result.html",
        {"request": request, "report_text": report_text, "organ": organ},
    )
```

### 10.2 Histology summary builder (Python)

The server-side summary is built via `build_histologic_summary()` and helper functions:

* `_collect_histology_rows()` reads `histologic_type_i/subtype_i/percent_i`.
* `_pick_primary_row()` chooses a row with greatest `(pct, has_subtype)` score.
* `_format_primary_parts()` builds primary fragments, avoiding duplicated strings if subtype starts with type label.
* `_format_non_primary_part()` handles remaining rows.

Notable refactor detail:

* Attempts were made to debug by inserting `__DEBUG__` returns in `_format_non_primary_part()`.
* It appeared `_format_primary_parts()` “was not running,” suggesting the symptom might be coming from the client-side (DOM-based) summary rather than the server-side builder, or that a different code path was being exercised.

---

## 11. Client-Side Implementation: Histology Mix Table and “組織型から自動入力”

### 11.1 What is invoked when 「組織型から自動入力」 is pressed

In `form_generic.html`, the button is:

```html
<button
  type="button"
  id="btn-fill-description-from-histology"
  style="font-size:0.8rem; padding:0.2rem 0.5rem;"
>
  組織型から自動入力
</button>
```

In `static-src/visibility.ts`, a click handler is registered at boot:

```ts
const descButton = byIdT<HTMLButtonElement>("btn-fill-description-from-histology");
if (descButton) {
  descButton.addEventListener("click", () => {
    const textarea = qsT<HTMLTextAreaElement>("textarea#description");
    if (!textarea) return;

    const summary = buildHistologicSummaryFromDOM(mixRows);
    if (!summary) return;

    textarea.value = summary;
    textarea.focus();
  });
}
```

So, pressing the button triggers:

* `buildHistologicSummaryFromDOM(mixRows)`
* which depends on:

  * `collectMixRowData(mixRows)`
  * `formatADMixture(...)`
  * `formatNonADRows(...)`

This is separate from the server-side `build_histologic_summary()`.

### 11.2 Mix-table logic and UI behavior

* `initMixTable()` wires change handlers, subtype filtering, percentage visibility rules, and AD total validation.
* `AD_CODE = "AD"` controls adenocarcinoma behavior:

  * Percentage input required only for AD.
  * For non-AD, percentage cell is hidden/disabled.
  * Non-AD single-row restriction is enforced.

Relevant snippets:

```ts
const AD_CODE = "AD";

function applyPctMode(r: MixRowEls): void {
  const typeCode = r.typeSelect.value;
  const isAD = typeCode === AD_CODE;
  const isEmpty = typeCode === "";
  const show = isAD || isEmpty;

  r.pctInput.disabled = !show;
  r.pctInput.required = isAD;

  if (!show) r.pctInput.value = "";

  r.pctInput.style.visibility = show ? "visible" : "hidden";
  setDisplay(pctCell, show ? "" : "none");
}
```

---

## 12. Histology Mix Summary: Requirements, Bugs, and Formatting Refactors (Client-Side)

### 12.1 Context

A “histologic mix” table is rendered in the form with repeated rows:

* `histologic_type_i`
* `histologic_subtype_i`
* `histologic_percent_i`

The summary is used in:

* The generated report (`data["histologic_summary"]` built server-side).
* The “組織型から自動入力” button (built client-side from DOM).

### 12.2 Desired formatting changes (key examples)

1. Parentheses for non-primary rows (same-type case):

* Desired: `papillary (40%), lepidic (10%)`
* Undesired: `papillary 40%, lepidic 10%`

2. Add colon after main type label for AD mixture:

* Desired: `Invasive non-mucinous adenocarcinoma: papillary (70%), acinar (30%)`
* Undesired: `Invasive non-mucinous adenocarcinoma, papillary (70%), acinar 30%`

3. Primary type selection must be correct, and primary subtype must be formatted consistently.

### 12.3 Formatting bug root cause (client-side)

Observed output:

* `Invasive non-mucinous adenocarcinoma, papillary (70%), acinar 30%`

This indicated:

* Primary subtype used parentheses correctly: `papillary (70%)`
* Non-primary subtype did not: `acinar 30%` (missing parentheses)

This symptom matched an earlier client-side formatter variant that emitted `"subtypeLabel pctText"` where `pctText` was `"30%"` instead of `"(30%)"`.

A helper function was introduced:

```ts
function pctParen(pct: number): string {
  return `(${pct.toFixed(0)}%)`;
}
```

Then non-primary formatting was updated to:

* `subtypeLabel + pctParen(pct)` instead of `subtypeLabel + " " + pctText`.

### 12.4 “Colon after type” refactor direction (client-side)

To produce:

* `Invasive non-mucinous adenocarcinoma: papillary (70%), acinar (30%)`

A refactor was proposed:

* Return AD output as one sentence (string) so punctuation can be `TYPE: ...`
* Then append non-AD parts after that, separated by commas.

Conceptual shape:

* `formatADMixtureAsSentence(adRows) -> string`
* `formatNonADRows(nonAdRows) -> string[]`
* `buildHistologicSummaryFromDOM(...) -> join([adSentence, ...nonAdParts])`

---

## 13. How to Run the System (Development Workflow)

### 13.1 Compile TypeScript

From repository root (where `tsconfig.json` exists):

```bash
npx tsc
```

This compiles `static-src/*.ts` to `static/*.js` (ES2020 modules).

### 13.2 Run FastAPI with Uvicorn

Typical command:

```bash
uvicorn app:app --reload
```

Then open:

* `http://127.0.0.1:8000/`
* `http://127.0.0.1:8000/lung` (example organ route)

### 13.3 Ensure templates reference correct compiled assets

Example:

```html
<script type="module" src="/static/visibility.js"></script>
```

If the code is compiled from `static-src/visibility.ts`, the output must be at:

* `static/visibility.js`

A 404 like `/static/dom` indicates a missing file or an incorrect `src` path.

---

## 14. Summary of Key Decisions and Outcomes

* Migrated complex DOM manipulation from JavaScript to TypeScript with:

  * typed wrappers for DOM querying
  * `WeakMap` caching instead of custom properties on nodes
  * safer element checks for `closest("td")`
* Addressed SonarLint feedback systematically:

  * complexity reduction via helper functions
  * removal of redundant calls
  * avoidance of unnecessary TS assertions
  * improved form-data multi-value handling
  * HTML label/control association fixes for accessibility
* Identified module-scope issues causing:

  * TS2393 duplicate function implementation
  * `export {};` related Sonar complaints
  * recommended shared module approach or exporting real symbols
* Identified a key architectural point:

  * There are two summary generators (Python server-side and TypeScript client-side), and alignment is required to avoid divergent formatting.

---

## 15. References Mentioned in the Work

* SonarLint / SonarQube issue codes:

  * `python:S3776` (Cognitive Complexity)
  * `python:S7508` (Redundant call)
  * `typescript:S4325` (Unnecessary assertion)
  * `typescript:S1874` (Deprecated `execCommand`)
  * `typescript:S7778` (“Do not call Array#push() multiple times.”)
  * `typescript:S7787` (Export statement without specifiers)
  * `Web:S6853` (Label-control association)
* Runtime stack:

  * FastAPI
  * Uvicorn
  * Jinja2Templates
  * Starlette `FormData` (via `request.form()`)
* Error trace (form parsing):

  * `AssertionError: The python-multipart library must be installed to use form parsing.`
