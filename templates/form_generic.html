<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>{{ config.display_name }} TNM Wizard</title>
  <link rel="stylesheet" href="/static/style.css">
  <script type="module" src="/static/visibility.js"></script>
</head>
<body>
  <h1>{{ config.display_name }} TNM Wizard</h1>

  {# --- macro for generic fields (no histology-specific branching here) --- #}
  {% macro render_input(field) %}
    {% if field.type == "radio" %}
      {% set default_value = field.default or "" %}
      {% for opt in field.options %}
        <label
          {% if opt.help %} title="{{ opt.help }}"{% endif %}
          class="radio-option"
        >
          <input
            type="radio"
            name="{{ field.name }}"
            value="{{ opt.code }}"
            {% if opt.code == default_value or opt.default %}checked{% endif %}
            required
          >
          {{ opt.label }}
        </label>
      {% endfor %}

    {% elif field.type == "select" %}
      <select
        name="{{ field.name }}"
        {% if field.depends_on_histologic_type %}
          data-histologic-subtype="true"
        {% endif %}
      >
        {% for opt in field.options %}
          <option
            value="{{ opt.code }}"
            {% if opt.parent_type %}
              data-parent-type="{{ opt.parent_type }}"
            {% endif %}
          >
            {{ opt.label }}
          </option>
        {% endfor %}
      </select>

    {% elif field.type == "checkbox" %}
      {% if field.options %}
        {# generic multi-choice checkboxes #}
        {% for opt in field.options %}
          <label class="checkbox-option"
                 {% if opt.help %}title="{{ opt.help }}"{% endif %}
          >
            <input
              type="checkbox"
              name="{{ field.name }}"
              value="{{ opt.code }}"
            >
            {{ opt.label }}
          </label>
        {% endfor %}
      {% else %}
        {# single boolean checkbox #}
        <label class="checkbox-option">
          <input type="checkbox" name="{{ field.name }}" value="true">
          {{ field.label }}
        </label>
      {% endif %}

    {% elif field.type == "number" %}
      <input
        type="number"
        min="0"
        step="{{ field.step or 1 }}"
        name="{{ field.name }}"
        {% if field.input_width %}style="width: {{ field.input_width }};"{% endif %}
      >

    {% elif field.type == "free_text" %}
      <input
        type="text"
        name="{{ field.name }}"
        {% if field.input_width %}style="width: {{ field.input_width }};"{% endif %}
      >

    {% elif field.type == "textarea" %}
      <textarea
        name="{{ field.name }}"
        id="{{ field.name }}"     {# so description has id="description" #}
        rows="{{ field.rows or 2 }}"
        class="{{ field.css_class or '' }}"
      ></textarea>

    {% else %}
      <input type="text" name="{{ field.name }}">
    {% endif %}
  {% endmacro %}

  {# --- macro to render all fields in a section --- #}
  {% macro render_section_fields(section) %}
    {% for field in section.fields %}

      {# 1) unified histologic mix table (type/subtype/% rows) #}
      {% if field.type == "histologic_mix" %}
        <div class="field histologic-mix" id="histologic-mix">
          <span class="field-label">{{ field.label }}:</span>

          <table class="histologic-mix-table">
            <thead>
              <tr>
                <th>組織型</th>
                <th>組織亜型</th>
                <th class="histologic-percent-header">割合(%)</th>
              </tr>
            </thead>
            <tbody>
              {% set max_rows = field.rows or 4 %}
              {% for i in range(1, max_rows + 1) %}
                <tr class="histologic-mix-row" data-row-index="{{ i }}">
                  {# 組織型 select #}
                  <td>
                    <select
                      name="histologic_type_{{ i }}"
                      class="histologic-type-select"
                      data-row="{{ i }}"
                    >
                      <option value="">--</option>
                      {% for t in field.types %}
                        <option value="{{ t.code }}">{{ t.label }}</option>
                      {% endfor %}
                    </select>
                  </td>

                  {# 組織亜型 select (options filtered per row by JS) #}
                  <td>
                    <select
                      name="histologic_subtype_{{ i }}"
                      class="histologic-subtype-select"
                      data-row="{{ i }}"
                    >
                      <option value="">--</option>
                      {% for t in field.types %}
                        {% for st in t.subtypes %}
                          <option
                            value="{{ st.code }}"
                            data-parent-type="{{ t.code }}"
                          >
                            {{ st.label }}
                          </option>
                        {% endfor %}
                      {% endfor %}
                    </select>
                  </td>

                  {# 割合(%) input – JS will:
                     - require + sum only when type = AD
                     - hide/disable for non-AD #}
                  <td style="text-align: right;">
                    <input
                      type="number"
                      name="histologic_percent_{{ i }}"
                      class="histologic-percent-input"
                      min="0"
                      max="100"
                      step="1"
                      style="width: 3rem; text-align: right;"
                    >
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          <small class="histologic-hint" style="display:none;">
            浸潤性非粘液性腺癌(AD)の場合、割合が 100% になるように入力します。主たる組織亜型は最大割合から自動判定されます。
          </small>
        </div>

      {# 2) nodal stations block #}
      {% elif field.type == "nodal_stations" %}
        <div class="field nodal-stations">
          <span class="field-label">{{ field.label }}:</span>

          {% for st in field.stations %}
            {% set chk_name      = "LN" ~ st.code %}
            {% set positive_name = "LN" ~ st.code ~ "_positive" %}
            {% set total_name    = "LN" ~ st.code ~ "_total" %}

            <div class="nodal-row">
              <label class="station-cell">
                <input type="checkbox" name="{{ chk_name }}" value="true">
                <span class="station-code">{{ st.label }}</span>
              </label>

              <input
                type="number"
                name="{{ positive_name }}"
                class="nodal-input"
                min="0"
                step="1"
                style="width: 3.0rem;"
                placeholder="positive"
                data-visible-if-field="{{ chk_name }}"
                data-visible-if-values="true"
              >

              <span
                class="nodal-slash"
                data-visible-if-field="{{ chk_name }}"
                data-visible-if-values="true"
              >/</span>

              <input
                type="number"
                name="{{ total_name }}"
                class="nodal-input"
                min="0"
                step="1"
                style="width: 3.0rem;"
                placeholder="total"
                data-visible-if-field="{{ chk_name }}"
                data-visible-if-values="true"
              >
            </div>
          {% endfor %}
        </div>

      {# 3) generic fields, including description textarea with autofill button #}
      {% else %}
        <div class="field {% if field.type == 'textarea' %}description-textarea{% endif %}"
             data-field-name="{{ field.name }}"
             {% if field.visible_if %}
               data-visible-if-field="{{ field.visible_if['field'] }}"
               data-visible-if-values="{{ field.visible_if['values'] | join(',') }}"
             {% endif %}
        >
          {% if not (field.type == "checkbox" and not field.options) %}

            {% if field.name == "description" %}
              <div style="display:flex; align-items:center; gap:0.5rem;">
                <label for="{{ field.name }}">{{ field.label }}:</label>
                <button
                  type="button"
                  id="btn-fill-description-from-histology"
                  style="font-size:0.8rem; padding:0.2rem 0.5rem;"
                >
                  組織型から自動入力
                </button>
              </div>
            {% else %}
              <label for="{{ field.name }}">{{ field.label }}:</label>
            {% endif %}

          {% endif %}

          {{ render_input(field) }}
        </div>
      {% endif %}

    {% endfor %}
  {% endmacro %}

  <form method="post" action="/{{ config.organ }}/generate">
    {% for section in config.sections %}

      {% if section.id == "nodal_metastasis" %}
        <details class="section-collapsible" open>
          <summary>{{ section.title }}</summary>
          <fieldset>
            <legend style="display:none">{{ section.title }}</legend>
            {{ render_section_fields(section) }}
          </fieldset>
        </details>
      {% else %}
        <fieldset>
          <legend>{{ section.title }}</legend>
          {{ render_section_fields(section) }}
        </fieldset>
      {% endif %}

    {% endfor %}

    <button type="submit">診断文を生成</button>
  </form>

  <p><a href="/">戻る</a></p>
</body>
</html>
