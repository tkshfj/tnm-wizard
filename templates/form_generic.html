<!DOCTYPE html>
<html lang="ja" data-theme="medical">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ config.display_name }} TNM Wizard</title>
  <link rel="stylesheet" href="/static/output.css">
  <script type="module" src="/static/visibility.js"></script>
</head>
<body class="bg-base-200 min-h-screen p-6">
  <div class="max-w-3xl mx-auto">
  <h1 class="text-2xl font-bold mb-4">{{ config.display_name }} TNM Wizard</h1>

  {# --- macro for generic fields (no histology-specific branching here) --- #}
  {% macro render_input(field) %}
    {% if field.type == "radio" %}
      <div class="flex flex-wrap gap-x-4 gap-y-1">
      {% set default_value = field.default or "" %}
      {% for opt in field.options %}
        <label
          {% if opt.help %} title="{{ opt.help }}"{% endif %}
          class="label cursor-pointer gap-2"
        >
          <input
            type="radio"
            name="{{ field.name }}"
            value="{{ opt.code }}"
            class="radio radio-primary radio-sm"
            {% if opt.code == default_value or opt.default %}checked{% endif %}
            required
          >
          <span class="label-text">{{ opt.label }}</span>
        </label>
      {% endfor %}
      </div>

    {% elif field.type == "select" %}
      <select
        name="{{ field.name }}"
        class="select select-bordered select-sm"
        {% if field.depends_on_histologic_type %}
          data-histologic-subtype="true"
        {% endif %}
      >
        {% for opt in field.options %}
          <option
            value="{{ opt.code }}"
            {% if opt.parent_type %}
              data-parent-type="{{ opt.parent_type }}"
            {% endif %}
          >
            {{ opt.label }}
          </option>
        {% endfor %}
      </select>

    {% elif field.type == "checkbox" %}
      {% if field.options %}
        <div class="flex flex-wrap gap-x-4 gap-y-1">
        {% for opt in field.options %}
          <label class="label cursor-pointer gap-2"
                 {% if opt.help %}title="{{ opt.help }}"{% endif %}
          >
            <input
              type="checkbox"
              name="{{ field.name }}"
              value="{{ opt.code }}"
              class="checkbox checkbox-primary checkbox-sm"
            >
            <span class="label-text">{{ opt.label }}</span>
          </label>
        {% endfor %}
        </div>
      {% else %}
        <label class="label cursor-pointer gap-2 justify-start">
          <input type="checkbox" name="{{ field.name }}" value="true"
                 class="checkbox checkbox-primary checkbox-sm">
          <span class="label-text">{{ field.label }}</span>
        </label>
      {% endif %}

    {% elif field.type == "number" %}
      <input
        type="number"
        min="0"
        step="{{ field.step or 1 }}"
        name="{{ field.name }}"
        class="input input-bordered input-sm w-20"
      >

    {% elif field.type == "free_text" %}
      <input
        type="text"
        name="{{ field.name }}"
        class="input input-bordered input-sm w-64"
      >

    {% elif field.type == "textarea" %}
      <textarea
        name="{{ field.name }}"
        id="{{ field.name }}"
        rows="{{ field.rows or 2 }}"
        class="textarea textarea-bordered w-full {{ field.css_class or '' }}"
      ></textarea>

    {% else %}
      <input type="text" name="{{ field.name }}" class="input input-bordered input-sm">
    {% endif %}
  {% endmacro %}

  {# --- macro to render all fields in a section --- #}
  {% macro render_section_fields(section) %}
    {% for field in section.fields %}

      {# 1) unified histologic mix table (type/subtype/% rows) #}
      {% if field.type == "histologic_mix" %}
        <div class="field histologic-mix mb-2" id="histologic-mix">
          <span class="field-label font-medium">{{ field.label }}:</span>

          <table class="histologic-mix-table table table-compact w-auto mt-1">
            <thead>
              <tr>
                <th>組織型</th>
                <th>組織亜型</th>
                <th class="histologic-percent-header text-right">割合(%)</th>
              </tr>
            </thead>
            <tbody>
              {% set max_rows = field.rows or 4 %}
              {% for i in range(1, max_rows + 1) %}
                <tr class="histologic-mix-row" data-row-index="{{ i }}">
                  {# 組織型 select #}
                  <td>
                    <select
                      name="histologic_type_{{ i }}"
                      class="histologic-type-select select select-bordered select-sm"
                      data-row="{{ i }}"
                    >
                      <option value="">--</option>
                      {% for t in field.types %}
                        <option value="{{ t.code }}">{{ t.label }}</option>
                      {% endfor %}
                    </select>
                  </td>

                  {# 組織亜型 select (options filtered per row by JS) #}
                  <td>
                    <select
                      name="histologic_subtype_{{ i }}"
                      class="histologic-subtype-select select select-bordered select-sm"
                      data-row="{{ i }}"
                    >
                      <option value="">--</option>
                      {% for t in field.types %}
                        {% for st in t.subtypes %}
                          <option
                            value="{{ st.code }}"
                            data-parent-type="{{ t.code }}"
                          >
                            {{ st.label }}
                          </option>
                        {% endfor %}
                      {% endfor %}
                    </select>
                  </td>

                  {# 割合(%) input #}
                  <td class="text-right">
                    <input
                      type="number"
                      name="histologic_percent_{{ i }}"
                      class="histologic-percent-input input input-bordered input-sm w-16 text-right"
                      min="0"
                      max="100"
                      step="1"
                    >
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          <small class="histologic-hint text-sm" style="display:none;">
            浸潤性非粘液性腺癌(AD)の場合、割合が 100% になるように入力します。主たる組織亜型は最大割合から自動判定されます。
          </small>
        </div>

      {# 2) nodal stations block #}
      {% elif field.type == "nodal_stations" %}
        <div class="field nodal-stations flex flex-col gap-1">
          <span class="field-label font-medium">{{ field.label }}:</span>

          {% for st in field.stations %}
            {% set chk_name      = "LN" ~ st.code %}
            {% set positive_name = "LN" ~ st.code ~ "_positive" %}
            {% set total_name    = "LN" ~ st.code ~ "_total" %}

            <div class="nodal-row flex items-center gap-2">
              <label class="station-cell inline-flex items-center gap-1 w-14">
                <input type="checkbox" name="{{ chk_name }}" value="true"
                       class="checkbox checkbox-primary checkbox-sm">
                <span class="station-code min-w-[2rem] text-right tabular-nums">{{ st.label }}</span>
              </label>

              <input
                type="number"
                name="{{ positive_name }}"
                class="nodal-input input input-bordered input-sm w-16 text-right"
                min="0"
                step="1"
                placeholder="positive"
                data-visible-if-field="{{ chk_name }}"
                data-visible-if-values="true"
              >

              <span
                class="nodal-slash text-center"
                data-visible-if-field="{{ chk_name }}"
                data-visible-if-values="true"
              >/</span>

              <input
                type="number"
                name="{{ total_name }}"
                class="nodal-input input input-bordered input-sm w-16 text-right"
                min="0"
                step="1"
                placeholder="total"
                data-visible-if-field="{{ chk_name }}"
                data-visible-if-values="true"
              >
            </div>
          {% endfor %}
        </div>

      {# 3) generic fields, including description textarea with autofill button #}
      {% else %}
        <div class="field mb-2 {% if field.type == 'textarea' %}flex flex-col items-start max-w-xl{% endif %}"
             data-field-name="{{ field.name }}"
             {% if field.visible_if %}
               data-visible-if-field="{{ field.visible_if['field'] }}"
               data-visible-if-values="{{ field.visible_if['values'] | join(',') }}"
             {% endif %}
        >
          {% if not (field.type == "checkbox" and not field.options) %}

            {% if field.name == "description" %}
              <div class="flex items-center gap-2 mb-1">
                <label for="{{ field.name }}" class="font-medium">{{ field.label }}:</label>
                <button
                  type="button"
                  id="btn-fill-description-from-histology"
                  class="btn btn-xs btn-outline"
                >
                  組織型から自動入力
                </button>
              </div>
            {% else %}
              <label for="{{ field.name }}" class="font-medium">{{ field.label }}:</label>
            {% endif %}

          {% endif %}

          {{ render_input(field) }}
        </div>
      {% endif %}

    {% endfor %}
  {% endmacro %}

  <form method="post" action="/{{ config.organ }}/generate">
    {% for section in config.sections %}

      {% if section.id == "nodal_metastasis" %}
        <details class="border border-base-300 rounded-box mb-4 bg-base-100 shadow" open>
          <summary class="cursor-pointer font-bold p-3">{{ section.title }}</summary>
          <fieldset class="px-4 pb-4">
            <legend class="sr-only">{{ section.title }}</legend>
            {{ render_section_fields(section) }}
          </fieldset>
        </details>
      {% else %}
        <div class="card bg-base-100 shadow mb-4">
          <div class="card-body p-4">
            <h2 class="card-title text-lg">{{ section.title }}</h2>
            {{ render_section_fields(section) }}
          </div>
        </div>
      {% endif %}

    {% endfor %}

    <button type="submit" class="btn btn-primary">診断文を生成</button>
  </form>

  <p class="mt-4"><a href="/" class="link">戻る</a></p>
  </div>
</body>
</html>
